---
- name: "PLAY 1 - demo utilisation playbook"
  # Target/Pattern  à qui s'adresse le PLAY
  hosts: all
  become: true

  vars:
    deploy_pwd: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32663630653035353462343961303333323066353064366336613639653336366164626638326162
          6633326464323666346465346266346231363537343364660a393166663736616462363931333361
          65346561396565396537643732616639373734336232366161376330303833633962633833653034
          3530336263343261360a333939643636613033346131376365323933393738656132313163353935
          3261

  # Déclaration du block tasks : appel des modules ansible
  tasks:
    - name: "Ajout de l'utilisateur de deploiement via ansible"
      ansible.builtin.user:
        name: deploy
        state: present
        shell: /bin/bash
        password: "{{ deploy_pwd }}"
    
    - name: "Dépose de la clé publique du ansible mgmt chez le user deploy"
      ansible.posix.authorized_key:
        user: deploy
        state: present
        key: "{{ lookup('file', '/home/ansible/.ssh/id_rsa.pub') }}"

    - name: "Deploiement du fichier de regle sudo pour le user deploy"
      ansible.builtin.copy:
        dest: /etc/sudoers.d/deploy
        content: "deploy ALL=(ALL) NOPASSWD:ALL"
        mode: 0440
        owner: root
        group: root
